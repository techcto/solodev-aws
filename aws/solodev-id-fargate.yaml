---
AWSTemplateFormatVersion: '2010-09-09'

Description: >

    Solodev ID for Fargate on AWS

Metadata: 
  AWS::CloudFormation::Interface: 
    ParameterGroups: 
      - 
        Label: 
          default: "Network Setup"
        Parameters: 
          - VPCID
          - Subnets
          - CredentialsParameter
      - 
        Label: 
          default: "App Settings"
        Parameters: 
            - AdminUser
            - AdminPassword
            - DatabaseName
            - DatabasePassword
            - StorageEncrypted
            - DeletionPolicy
      - 
        Label: 
          default: "Optional: SSL Configuration"
        Parameters: 
          - FQDN
          - CertificateArn

Parameters:

    VPCID: 
        Type: AWS::EC2::VPC::Id
        Description: Choose which VPC the Application should be deployed to
        AllowedPattern: .+
        ConstraintDescription: Please choose VPC

    Subnets:
        Description: Choose at least two public subnets for this application
        Type: List<AWS::EC2::Subnet::Id>
        AllowedPattern: .+
        ConstraintDescription: Please choose Subnets

    FQDN:
        Type: String
        Description: URL for app. FQDN must be pointed to CNAME of ALB.

    PoolId:
        Type: String
        Description: AWS Cognito User Pool Id

    AccessKey:
        Type: String
        Description: AWS IAM KEY for access Cognito

    AccessSecret:
        Type: String
        Description: AWS IAM Secret for access Cognito

    ClientId:
        Type: String
        Description: AWS Cognito App Id

    ClientSecret:
        Type: String
        Description: AWS Cognito App Secret

    CertificateArn:
        Type: String
        Description: CertificateArn for SSL cert that matches the FQDN above. Please visit the AWS Certificate Manager.

    InstanceCount:
        Description: 'Number of instances behind load balancer.  Minimum 2 required for high availability.'
        Default: 2
        AllowedValues: [1, 2, 3, 4, 5]
        Type: Number

    AdminUser:
        Description: The solodev admin username
        Type: String
        Default: 'solodev'
        AllowedPattern: .+
        ConstraintDescription: Please set admin username

    AdminPassword:
        NoEcho: true
        Description: The solodev admin password
        Type: String
        MinLength: 1
        MaxLength: 41
        AllowedPattern: .+
        ConstraintDescription: Please set admin password

    DatabaseName:
        Description: The solodev database name
        Type: String
        MinLength: '1'
        MaxLength: '64'
        AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
        ConstraintDescription: must begin with a letter and contain only alphanumeric characters.
        Default: 'solodev'

    DatabasePassword:
        NoEcho: true
        Description: The database root password
        Type: String
        MinLength: 1
        MaxLength: 41
        AllowedPattern: .+
        ConstraintDescription: Please set database root password

    CredentialsParameter:
        Type: String
        Description: DockerHub Secret
        Default: ''

    StorageEncrypted:
        Default: 'true'
        Description: Enable encryption for both Database (RDS) and Filesystem (EFS)
        Type: String
        AllowedValues:
        - 'true'
        - 'false'
        ConstraintDescription: must be either true or false.

    DeletionPolicy:
        Default: 'Delete'
        Type: String
        Description: 'Experimental: Deletion Policy (Retain, Delete, Snapshot)'

Resources:

    ALB:
        Type: AWS::CloudFormation::Stack
        Properties:
            TemplateURL: https://s3.amazonaws.com/solodev-aws-ha/aws/infrastructure/alb.yaml
            Parameters:
                EnvironmentName: !Ref AWS::StackName
                VPC: !Ref VPCID
                CertificateArn: !Ref CertificateArn
                Subnets: !Join [",", [!Select [0, !Ref Subnets], !Select [1, !Ref Subnets]]]

    FARGATE:
        Type: AWS::CloudFormation::Stack
        Properties:
            TemplateURL: https://s3.amazonaws.com/solodev-aws-ha/aws/infrastructure/fargate.yaml
            Parameters:
                EnvironmentName: !Ref AWS::StackName
                VPC: !Ref VPCID
                LoadBalancerSecurityGroup: !GetAtt ALB.Outputs.LoadBalancerSecurityGroup
                Subnets: !Join [",", [!Select [0, !Ref Subnets], !Select [1, !Ref Subnets]]]

    RDS:
        Type: AWS::CloudFormation::Stack
        Properties:
            TemplateURL: https://s3.amazonaws.com/solodev-aws-ha/aws/infrastructure/rds.yaml
            Parameters:
                EnvironmentName: !Ref AWS::StackName
                DatabaseName: !Ref DatabaseName
                VPC: !Ref VPCID
                LoadBalancerSecurityGroup: !GetAtt ALB.Outputs.LoadBalancerSecurityGroup
                Subnets: !Join [",", [!Select [0, !Ref Subnets], !Select [1, !Ref Subnets]]]
                DatabasePassword: !Ref DatabasePassword
                DeletionPolicy: !Ref DeletionPolicy
                StorageEncrypted: !Ref StorageEncrypted
                MultiAZDatabase: 'false'

    ID:
        Type: AWS::CloudFormation::Stack
        DependsOn: RDS
        Properties:
            TemplateURL: https://s3.amazonaws.com/solodev-aws-ha/aws/services/fargate-solodev-id.yaml
            Parameters:
                EnvironmentName: !Ref AWS::StackName
                VPC: !Ref VPCID
                Cluster: !GetAtt FARGATE.Outputs.Cluster
                ClusterArn: !GetAtt FARGATE.Outputs.ClusterArn
                LoadBalancer: !GetAtt ALB.Outputs.LoadBalancer
                LoadBalancerSecurityGroup: !GetAtt ALB.Outputs.LoadBalancerSecurityGroup
                Subnets: !Join [",", [!Select [0, !Ref Subnets], !Select [1, !Ref Subnets]]]
                AdminUsername: !Ref AdminUser
                AdminPassword: !Ref AdminPassword
                CredentialsParameter: !Ref CredentialsParameter
                DatabaseHost: !GetAtt RDS.Outputs.DatabaseHost
                DatabaseName: !Ref DatabaseName
                DatabaseUsername: 'identity'
                DatabaseClass: 'db.t2.medium'
                DatabasePassword: !Ref DatabasePassword
                FQDN: !Ref FQDN
                CertificateArn: !Ref CertificateArn
                DesiredCount: !Ref InstanceCount
                AccessSecret: !Ref AccessSecret
                PoolId: !Ref PoolId
                ClientSecret: !Ref ClientSecret
                ClientId: !Ref ClientId
                AccessKey: !Ref AccessKey
                ServiceRole: !GetAtt ALB.Outputs.ServiceRole 
                Path: / 

Outputs:
    AdminUrl: 
        Description: The URL endpoint for the load balancer. Point your DNS to this CNAME.
        Value: !GetAtt ALB.Outputs.LoadBalancerUrl
    AdminUsername: 
        Description: Portal admin username.
        Value: !Ref AdminUser
    AdminPassword: 
        Description: Portal admin password.
        Value: !Ref AdminPassword